<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cotizador de env√≠os</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&display=swap');
        :root {
            --bg-color: #f4f4f4;
            --text-color: #13252B;
            --container-bg: #fff;
            --input-bg: #f9f9f9;
            --border-color: #ddd;
            --primary-color: #00B022;
            --primary-hover: #038919;
            --shadow: 0 0 15px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
            --border-radius: 10px;
        }
        
        [data-theme="dark"] {
            --bg-color: #121212;
            --text-color: #f0f0f0;
            --container-bg: #1e1e1e;
            --input-bg: #2d2d2d;
            --border-color: #444;
            --primary-color: #00a020;
            --primary-hover: #007a18;
            --shadow: 0 0 15px rgba(0, 0, 0, 0.3);
        }
        
        * {
            box-sizing: border-box;
            transition: background-color 0.3s, color 0.3s;
        }
        
        body {
            font-family: 'Montserrat', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            line-height: 1.6;
        }
        
        .container {
            background-color: var(--container-bg);
            padding: 30px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            width: 100%;
            max-width: 800px;
            text-align: center;
            position: relative;
            animation: fadeIn 0.5s ease-out;
            overflow: hidden;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        h1 {
            color: var(--text-color);
            margin-bottom: 20px;
            font-size: clamp(1.5rem, 2.5vw, 2rem);
            animation: slideDown 0.5s ease-out;
        }
        
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        label {
            display: block;
            margin-top: 15px;
            color: var(--text-color);
            font-weight: 600;
            text-align: left;
            font-size: 0.9rem;
        }
        
        input, select, button {
            width: 100%;
            padding: 12px 15px;
            margin-top: 8px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            font-family: 'Montserrat', sans-serif;
            font-size: 0.95rem;
            transition: var(--transition);
        }
        
        input, select {
            background-color: var(--input-bg);
            color: var(--text-color);
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(0, 176, 34, 0.2);
        }
        
        button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            cursor: pointer;
            margin-top: 20px;
            font-weight: 600;
            letter-spacing: 0.5px;
            transition: var(--transition);
        }
        
        button:hover {
            background-color: var(--primary-hover);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        #resultado {
            margin-top: 25px;
            font-size: 1rem;
            color: var(--text-color);
            text-align: left;
            background: rgba(0, 176, 34, 0.05);
            padding: 15px;
            border-radius: var(--border-radius);
            border-left: 4px solid var(--primary-color);
            animation: fadeIn 0.5s ease-out;
            display: block !important;
            opacity: 1 !important;
        }
        
        #resultado h3 {
            color: var(--primary-color);
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 1.2rem;
        }
        
        #resultado p {
            margin: 10px 0;
            padding: 5px 0;
            border-bottom: 1px dashed var(--border-color);
        }
        
        #resultado p:last-child {
            border-bottom: none;
            font-weight: 600;
        }
        
        #resultado .monto-final {
            color: var(--primary-color);
            font-weight: 800;
            font-size: 1.1rem;
        }
        
        .spinner {
            display: none;
            margin: 20px auto;
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .hidden {
            display: none !important;
        }
        
        img {
            width: 200px;
            max-width: 80%;
            margin-bottom: 20px;
            animation: fadeIn 0.8s ease-out;
        }
        
        .form-section {
            margin-bottom: 30px;
            animation: fadeIn 0.6s ease-out;
        }
        
        .form-section h2 {
            text-align: left;
            color: var(--text-color);
            margin-bottom: 15px;
            font-size: 1.2rem;
            position: relative;
            padding-bottom: 5px;
        }
        
        .form-section h2::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 50px;
            height: 3px;
            background: var(--primary-color);
        }
        
        .aligned-input {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            margin-bottom: 15px;
        }
        
        .mode-selector {
            display: flex;
            justify-content: center;
            margin-bottom: 25px;
            gap: 10px;
        }
        
        .mode-btn {
            padding: 12px 25px;
            background-color: var(--input-bg);
            color: var(--text-color);
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: var(--transition);
            font-weight: 600;
            font-size: 0.9rem;
            flex: 1;
            max-width: 200px;
            text-align: center;
            border: 1px solid var(--border-color);
        }
        
        .mode-btn.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        
        .mode-btn:not(.active):hover {
            background-color: var(--bg-color);
        }
        
        .error-message {
            color: #ff4444;
            font-size: 0.8rem;
            margin-top: 5px;
            display: none;
            text-align: left;
            animation: shake 0.3s ease;
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            20%, 60% { transform: translateX(-5px); }
            40%, 80% { transform: translateX(5px); }
        }
        
        .tooltip {
            position: relative;
            display: inline-block;
            border-bottom: 1px dotted var(--text-color);
            cursor: help;
        }
        
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 200px;
            background-color: #555;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 8px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -100px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.85rem;
            font-weight: normal;
        }
        
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
        
        .theme-switch {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }
        
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .slider {
            background-color: var(--primary-color);
        }
        
        input:checked + .slider:before {
            transform: translateX(26px);
        }
        
        #themeLabel {
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        /* Estilos para los campos de cantidad */
        .important-field {
            font-weight: 800;
            color: var(--primary-color);
            margin-top: 20px;
            font-size: 1rem;
            display: flex;
            align-items: center;
        }
        
        .important-input {
            border: 2px solid var(--primary-color);
            background-color: rgba(0, 176, 34, 0.05);
            font-weight: 600;
            transition: var(--transition);
        }
        
        .field-icon {
            margin-right: 8px;
            font-size: 1.1em;
        }
        
        @keyframes pulseGlow {
            0% { box-shadow: 0 0 0 rgba(0, 176, 34, 0); }
            50% { box-shadow: 0 0 10px rgba(0, 176, 34, 0.3); }
            100% { box-shadow: 0 0 0 rgba(0, 176, 34, 0); }
        }
        
        .important-input:focus {
            animation: pulseGlow 2s infinite;
            outline: none;
            background-color: var(--input-bg);
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }
            
            .mode-selector {
                flex-direction: column;
                align-items: center;
            }
            
            .mode-btn {
                max-width: 100%;
                width: 100%;
            }
            
            .theme-switch {
                position: static;
                justify-content: flex-end;
                margin-bottom: 15px;
            }
            
            input, select, button {
                padding: 10px 12px;
            }
            
            #resultado {
                font-size: 0.9rem;
            }
        }
        
        @media (max-width: 480px) {
            body {
                padding: 10px;
            }
            
            .container {
                padding: 15px;
            }
            
            h1 {
                font-size: 1.3rem;
                margin-bottom: 15px;
            }
            
            .form-section h2 {
                font-size: 1.1rem;
            }
            
            label {
                font-size: 0.85rem;
            }
        }
        
        /* Animaci√≥n para los campos del formulario */
        .form-section > * {
            animation: fadeInUp 0.5s ease-out forwards;
            opacity: 0;
            transform: translateY(10px);
        }
        
        @keyframes fadeInUp {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>
<body data-theme="light">
    <div class="container">
        <div class="theme-switch">
            <label class="switch">
                <input type="checkbox" id="themeToggle">
                <span class="slider round"></span>
            </label>
            <span id="themeLabel">Modo Oscuro</span>
        </div>
        
        <img src="Logo color horizontal.png" alt="Logo" class="logo">
        <h1>Cotizador de env√≠os</h1>
        
        <div class="mode-selector">
            <div class="mode-btn active" id="modeSend" onclick="setMode('send')">Quiero enviar</div>
            <div class="mode-btn" id="modeReceive" onclick="setMode('receive')">Quiero recibir</div>
        </div>

        <div class="form-section">
            <label for="monedaOrigen">Moneda de Origen:</label>
            <select id="monedaOrigen">
                <option value="COP">Peso Colombiano (COP)</option>
                <option value="BRL">Real Brasile√±o (BRL)</option>
                <option value="MXN">Peso Mexicano (MXN)</option>
                <option value="CLP">Peso Chileno (CLP)</option>
                <option value="PEN">Sol Peruano (PEN)</option>
                <option value="PYG">Guaran√≠ Paraguayo (PYG)</option>
                <option value="UYU">Peso Uruguayo (UYU)</option>
                <option value="USD">D√≥lar Estadounidense (USD)</option>
                <option value="EUR">Euro (EUR)</option>
                <option value="HKD">D√≥lar de Hong Kong (HKD)</option>
                <option value="CNY">Yuan Chino (CNY)</option>
            </select>
            <label for="monedaDestino">Moneda de Destino:</label>
            <select id="monedaDestino">
                <option value="COP">Peso Colombiano (COP)</option>
                <option value="BRL">Real Brasile√±o (BRL)</option>
                <option value="MXN">Peso Mexicano (MXN)</option>
                <option value="CLP">Peso Chileno (CLP)</option>
                <option value="PEN">Sol Peruano (PEN)</option>
                <option value="PYG">Guaran√≠ Paraguayo (PYG)</option>
                <option value="UYU">Peso Uruguayo (UYU)</option>
                <option value="USD">D√≥lar Estadounidense (USD)</option>
                <option value="EUR">Euro (EUR)</option>
                <option value="HKD">D√≥lar de Hong Kong (HKD)</option>
                <option value="CNY">Yuan Chino (CNY)</option>
            </select>
            
            <div id="sendSection">
                <label for="cantidadEnviar" class="important-field">
                    <span class="field-icon">üí∞</span>
                    Cantidad a enviar:
                </label>
                <input type="text" id="cantidadEnviar" placeholder="Ej: 1.000.000" class="important-input">
                <div class="error-message" id="errorCantidadEnviar">Ingrese un valor num√©rico v√°lido</div>
            </div>
            
            <div id="receiveSection" class="hidden">
                <label for="cantidadRecibir" class="important-field">
                    <span class="field-icon">üí∞</span>
                    Cantidad a recibir:
                </label>
                <input type="text" id="cantidadRecibir" placeholder="Ej: 500.000" class="important-input">
                <div class="error-message" id="errorCantidadRecibir">Ingrese un valor num√©rico v√°lido</div>
            </div>
            
            <label for="comision">Comisi√≥n (%):</label>
            <input type="text" id="comision" placeholder="Ej: 5,00" value="5,00">
            <div class="error-message" id="errorComision">Ingrese un porcentaje v√°lido (0-100)</div>
            
            <button onclick="calcularEnvio()">Cotizar</button>
            <div class="spinner" id="spinner"></div>
            <div id="resultado"></div>
        </div>

        <div id="datosEnvio" class="hidden form-section">
            <h2>Datos de Envio</h2>
            <div class="aligned-input">
                <label for="solicitante">Solicitante:</label>
                <input type="text" id="solicitante" placeholder="Nombre del solicitante">
            </div>
            <div class="aligned-input">
                <label for="beneficiario">Beneficiario:</label>
                <input type="text" id="beneficiario" placeholder="Nombre del beneficiario">
            </div>
            <div class="aligned-input">
                <label for="tipoID">Tipo de ID:</label>
                <input type="text" id="tipoID" placeholder="Tipo de identificaci√≥n (CC, Pasaporte, etc.)">
            </div>
            <div class="aligned-input">
                <label for="numeroID">N√∫mero de ID:</label>
                <input type="text" id="numeroID" placeholder="N√∫mero de identificaci√≥n">
            </div>
            <div class="aligned-input">
                <label for="tipoCuenta">Tipo de cuenta:</label>
                <input type="text" id="tipoCuenta" placeholder="Ahorros, Corriente, etc.">
            </div>
            <div class="aligned-input">
                <label for="numeroCuenta">N√∫mero de cuenta:</label>
                <input type="text" id="numeroCuenta" placeholder="N√∫mero de cuenta bancaria">
            </div>
            <button onclick="confirmarCotizacion()">Confirmar Cotizaci√≥n</button>
        </div>
    </div>

<script>
    // CONSTANTES Y VARIABLES GLOBALES
    const sheetDBURL = 'https://sheetdb.io/api/v1/40v2uh03f9082';
    let currentMode = 'send';
    let tasaCambioActual = 0;
    const usuarioActual = "OP"; // Cambiar por tu sistema de usuarios
    
    // INICIALIZACI√ìN
    document.addEventListener('DOMContentLoaded', function() {
        configurarAutoFormato();
        setMode('send');
        cargarTemaGuardado();
        console.log("Sistema inicializado. Modo:", currentMode);
        
        // Agregar animaci√≥n de carga inicial
        document.querySelectorAll('.form-section > *').forEach((el, index) => {
            el.style.animationDelay = `${index * 0.1}s`;
        });
    });

    // FUNCIONES PRINCIPALES
    function setMode(mode) {
        currentMode = mode;
        document.getElementById('modeSend').classList.toggle('active', mode === 'send');
        document.getElementById('modeReceive').classList.toggle('active', mode === 'receive');
        document.getElementById('sendSection').classList.toggle('hidden', mode !== 'send');
        document.getElementById('receiveSection').classList.toggle('hidden', mode !== 'receive');
        
        // Enfocar autom√°ticamente el campo correspondiente
        setTimeout(() => {
            const fieldToFocus = mode === 'send' ? 'cantidadEnviar' : 'cantidadRecibir';
            document.getElementById(fieldToFocus)?.focus();
        }, 100);
    }

    // FUNCIONES DE ENV√çO COMPLETAMENTE SEPARADAS - VERSI√ìN CORREGIDA
    async function enviarAlHistorial(datos) {
        // Validaci√≥n m√°s estricta
        const camposProhibidos = ['Solicitante', 'Beneficiario', 'Tipo de ID', 'N√∫mero de ID', 'Tipo de cuenta', 'N√∫mero de cuenta'];
        for (const campo of camposProhibidos) {
            if (datos[campo]) {
                throw new Error(`Campo prohibido detectado en Historial: ${campo}`);
            }
        }

        const payload = {
            "Timestamp": new Date().toISOString(),
            "Modo": datos.modo === 'send' ? "Enviar" : "Recibir",
            "MonedaOrigen": datos.monedaOrigen,
            "MonedaDestino": datos.monedaDestino,
            "MontoOrigen": datos.montoOrigen,
            "MontoDestino": datos.montoDestino,
            "TasaCambio": parseFloat(datos.tasaCambio).toFixed(6),
            "Comision": parseFloat(datos.comision), // Asegurar formato num√©rico
            "Usuario": datos.usuario || "SISTEMA"
        };

        console.log("[HISTORIAL] Enviando:", payload);
        
        const response = await fetch(`${sheetDBURL}?sheetName=Historial`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        
        if (!response.ok) throw new Error("Error al enviar a Historial");
        return await response.json();
    }

    async function enviarAInfoCotizador(datos) {
        // Validaci√≥n m√°s completa
        const required = ['Solicitante', 'Beneficiario', 'Tipo de ID', 'N√∫mero de ID'];
        const missingFields = required.filter(field => !datos[field] || datos[field].trim() === '');
        
        if (missingFields.length > 0) {
            throw new Error(`Campos requeridos faltantes: ${missingFields.join(', ')}`);
        }

        // Limpieza de datos
        const payload = {
            "fecha": new Date().toLocaleDateString('pt-BR'),
            "Hora": new Date().toLocaleTimeString('en-US', { hour12: false }),
            "Solicitante": datos.Solicitante.trim(),
            "Beneficiario": datos.Beneficiario.trim(),
            "Tipo de ID": datos["Tipo de ID"].trim(),
            "N√∫mero de ID": datos["N√∫mero de ID"].trim(),
            "Tipo de cuenta": datos["Tipo de cuenta"]?.trim() || "",
            "N√∫mero de cuenta": datos["N√∫mero de cuenta"]?.trim() || "",
            "cantidad": parseFloat(datos.cantidad),
            "monedaOrigen": datos.monedaOrigen,
            "monedaDestino": datos.monedaDestino,
            "Valor cotizado": parseFloat(datos["Valor cotizado"]),
            "Comision": parseFloat(datos.Comision), // Asegurar formato num√©rico
            "Modo": datos.Modo,
            "Verificacion": ""
        };

        console.log("[INFO COTIZADOR] Enviando:", payload);
        
        const response = await fetch(`${sheetDBURL}?sheetName=Info Cotizador`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        
        if (!response.ok) throw new Error("Error al enviar a Info Cotizador");
        return await response.json();
    }

    // USO EN LAS FUNCIONES PRINCIPALES
    async function calcularEnvio() {
        try {
            // Validar campos b√°sicos
            if (!validarCamposCotizacion()) {
                console.warn("Validaci√≥n fallida en campos de cotizaci√≥n");
                return;
            }

            // Obtener datos del formulario
            const { monedaOrigen, monedaDestino, comision, cantidad } = obtenerDatosCotizacion();
            const esModoRecibir = currentMode === 'receive';
            
            console.log("Datos obtenidos:", { 
                monedaOrigen, 
                monedaDestino, 
                comision, 
                cantidad, 
                modo: currentMode 
            });

            // Mostrar spinner
            document.getElementById('spinner').style.display = 'block';
            document.querySelector('button').classList.add('loading');

            // Obtener tasa de cambio
            tasaCambioActual = await obtenerTasaCambio(monedaOrigen, monedaDestino);
            console.log("Tasa obtenida:", tasaCambioActual);
            
            // Calcular montos
            const { montoConvertido, montoComision, montoFinal, cantidadNecesaria } = calcularMontos(
                cantidad, 
                comision, 
                tasaCambioActual, 
                esModoRecibir
            );

            console.log("Montos calculados:", {
                montoConvertido,
                montoComision,
                montoFinal,
                cantidadNecesaria
            });

            // SOLO HISTORIAL - NUNCA A INFO COTIZADOR
            await enviarAlHistorial({
                modo: currentMode,
                monedaOrigen,
                monedaDestino,
                montoOrigen: esModoRecibir ? cantidadNecesaria : cantidad,
                montoDestino: montoFinal,
                tasaCambio: tasaCambioActual,
                comision: parseFloat(comision),
                usuario: usuarioActual
            });

            // Mostrar resultados
            mostrarResultados(monedaOrigen, monedaDestino, cantidad, montoConvertido, montoComision, montoFinal, esModoRecibir);
            
            // Mostrar secci√≥n de datos completos con animaci√≥n
            const datosEnvio = document.getElementById('datosEnvio');
            datosEnvio.classList.remove('hidden');
            datosEnvio.style.animation = 'fadeIn 0.6s ease-out';
            
            // Scroll suave a la secci√≥n de datos
            setTimeout(() => {
                datosEnvio.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }, 100);
            
            console.log("Cotizaci√≥n completada y guardada en Historial");

        } catch (error) {
            console.error('Error en calcularEnvio:', error);
            mostrarError('Error al procesar la cotizaci√≥n: ' + error.message);
        } finally {
            document.getElementById('spinner').style.display = 'none';
            document.querySelector('button').classList.remove('loading');
        }
    }

    function mostrarResultados(monedaOrigen, monedaDestino, cantidad, montoConvertido, montoComision, montoFinal, esModoRecibir) {
        const resultadoDiv = document.getElementById('resultado');
        
        // Limpiar y asegurar que el div sea visible
        resultadoDiv.innerHTML = '';
        resultadoDiv.style.display = 'block';
        resultadoDiv.style.opacity = '1';
        
        // Crear contenido HTML directamente
        resultadoDiv.innerHTML = `
            <h3 style="color: var(--primary-color); margin-top: 0; margin-bottom: 15px;">üìä Resultado de la Cotizaci√≥n</h3>
            <p><strong>üí± Tasa de Cambio:</strong> 1 ${monedaOrigen} = ${formatearTasaCambio(tasaCambioActual)} ${monedaDestino}</p>
            ${esModoRecibir ? 
                `<p><strong>üì§ Cantidad necesaria a enviar:</strong> ${formatearMontoFiat(cantidad)} ${monedaOrigen}</p>` : 
                `<p><strong>üì• Monto Original:</strong> ${formatearMontoFiat(cantidad)} ${monedaOrigen}</p>`}
            <p><strong>üîÑ Monto Convertido:</strong> ${formatearMontoFiat(montoConvertido)} ${monedaDestino}</p>
            <p><strong>üí∏ Comisi√≥n (${formatearMontoFiat(montoComision/montoConvertido*100)}%):</strong> -${formatearMontoFiat(montoComision)} ${monedaDestino}</p>
            <p><strong>‚úÖ Monto Final a Recibir:</strong> <span class="monto-final">${formatearMontoFiat(montoFinal)} ${monedaDestino}</span></p>
        `;
        
        // Forzar repintado para asegurar que se muestre
        void resultadoDiv.offsetHeight;
    }

    async function confirmarCotizacion() {
        try {
            if (!confirm("¬øEst√° seguro que desea confirmar esta cotizaci√≥n?")) {
                return;
            }

            // Validar campos completos
            if (!validarDatosCompletos()) {
                console.warn("Validaci√≥n fallida en datos completos");
                return;
            }

            // Obtener datos del formulario
            const datos = obtenerDatosCompletos();
            console.log("Datos completos obtenidos:", datos);
            
            // Mostrar spinner
            document.getElementById('spinner').style.display = 'block';
            document.querySelector('#datosEnvio button').classList.add('loading');

            // SOLO INFO COTIZADOR - NUNCA A HISTORIAL
            await enviarAInfoCotizador(datos);
            
            // Mostrar confirmaci√≥n con animaci√≥n
            const resultado = document.getElementById('resultado');
            resultado.innerHTML = `
                <div style="animation: fadeIn 0.5s ease-out">
                    <p style="color: var(--primary-color); font-weight: 800; text-align: center;">
                        ‚úì Env√≠o registrado correctamente
                    </p>
                    <p><strong>N√∫mero de transacci√≥n:</strong> ${Math.floor(Math.random() * 1000000).toString().padStart(6, '0')}</p>
                </div>
            `;
            
            // Resetear formulario despu√©s de un breve retraso
            setTimeout(resetForm, 2000);
            
        } catch (error) {
            console.error('Error en confirmarCotizacion:', error);
            mostrarError('Error al registrar el env√≠o completo: ' + error.message);
        } finally {
            document.getElementById('spinner').style.display = 'none';
            document.querySelector('#datosEnvio button').classList.remove('loading');
        }
    }

    function mostrarError(mensaje) {
        const resultado = document.getElementById('resultado');
        resultado.innerHTML = `
            <p style="color: #ff4444; font-weight: 600; animation: shake 0.5s;">
                ‚úó ${mensaje}
            </p>
        `;
    }

    // FUNCIONES DE APOYO (VALIDACI√ìN)
    function validarCamposCotizacion() {
        const campos = currentMode === 'send' 
            ? ['cantidadEnviar', 'comision'] 
            : ['cantidadRecibir', 'comision'];
        
        let todosValidos = true;
        
        campos.forEach(id => {
            const input = document.getElementById(id);
            if (!validarCampo(input)) {
                todosValidos = false;
                // Scroll al campo con error
                setTimeout(() => {
                    input.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }, 100);
            }
        });
        
        if (!todosValidos) {
            return false;
        }
        
        return true;
    }

    function validarDatosCompletos() {
        const camposRequeridos = [
            'solicitante', 'beneficiario', 'tipoID', 'numeroID'
        ];
        
        for (const id of camposRequeridos) {
            const input = document.getElementById(id);
            if (!input.value.trim()) {
                mostrarError(`El campo ${input.placeholder} es obligatorio`);
                input.focus();
                setTimeout(() => {
                    input.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }, 100);
                return false;
            }
            
            // Validaci√≥n adicional para n√∫meros de identificaci√≥n
            if (id === 'numeroID' && !/^[\d\-\.]+$/.test(input.value)) {
                mostrarError("N√∫mero de ID inv√°lido. Solo debe contener n√∫meros");
                input.focus();
                return false;
            }
        }
        
        return true;
    }

    function validarCampo(input) {
        const value = input.value;
        const errorId = `error${input.id.charAt(0).toUpperCase() + input.id.slice(1)}`;
        const errorElement = document.getElementById(errorId);
        
        if (!errorElement) return true;
        
        let isValid = true;
        
        if (input.id === 'comision') {
            const valorNumerico = parseFloat(input.dataset.rawValue || value.replace(',', '.'));
            isValid = !isNaN(valorNumerico) && valorNumerico >= 0 && valorNumerico <= 100;
        } else {
            const valorNumerico = parseInt(value.replace(/\./g, ''));
            isValid = !isNaN(valorNumerico) && valorNumerico > 0;
        }
        
        errorElement.style.display = isValid ? 'none' : 'block';
        return isValid;
    }

    // FUNCIONES DE APOYO (VALIDACI√ìN)
    function validarCamposCotizacion() {
        const campos = currentMode === 'send' 
            ? ['cantidadEnviar', 'comision'] 
            : ['cantidadRecibir', 'comision'];
        
        let todosValidos = true;
        
        campos.forEach(id => {
            const input = document.getElementById(id);
            if (!validarCampo(input)) {
                todosValidos = false;
                // Scroll al campo con error
                setTimeout(() => {
                    input.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }, 100);
            }
        });
        
        if (!todosValidos) {
            return false;
        }
        
        return true;
    }

    function validarDatosCompletos() {
        const camposRequeridos = [
            'solicitante', 'beneficiario', 'tipoID', 'numeroID'
        ];
        
        for (const id of camposRequeridos) {
            const input = document.getElementById(id);
            if (!input.value.trim()) {
                mostrarError(`El campo ${input.placeholder} es obligatorio`);
                input.focus();
                setTimeout(() => {
                    input.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }, 100);
                return false;
            }
            
            // Validaci√≥n adicional para n√∫meros de identificaci√≥n
            if (id === 'numeroID' && !/^[\d\-\.]+$/.test(input.value)) {
                mostrarError("N√∫mero de ID inv√°lido. Solo debe contener n√∫meros");
                input.focus();
                return false;
            }
        }
        
        return true;
    }

    function validarCampo(input) {
        const value = input.value;
        const errorId = `error${input.id.charAt(0).toUpperCase() + input.id.slice(1)}`;
        const errorElement = document.getElementById(errorId);
        
        if (!errorElement) return true;
        
        let isValid = true;
        
        if (input.id === 'comision') {
            const valorNumerico = parseFloat(input.dataset.rawValue || value.replace(',', '.'));
            isValid = !isNaN(valorNumerico) && valorNumerico >= 0 && valorNumerico <= 100;
        } else {
            const valorNumerico = parseInt(value.replace(/\./g, ''));
            isValid = !isNaN(valorNumerico) && valorNumerico > 0;
        }
        
        errorElement.style.display = isValid ? 'none' : 'block';
        return isValid;
    }

    // FUNCIONES DE APOYO (DATOS)
    function obtenerDatosCotizacion() {
        return {
            monedaOrigen: document.getElementById('monedaOrigen').value,
            monedaDestino: document.getElementById('monedaDestino').value,
            comision: limpiarNumeroBR(document.getElementById('comision').value),
            cantidad: limpiarNumeroBR(
                currentMode === 'receive' 
                    ? document.getElementById('cantidadRecibir').value 
                    : document.getElementById('cantidadEnviar').value
            )
        };
    }

    function obtenerDatosCompletos() {
        const resultadoTexto = document.getElementById('resultado').innerText;
        
        return {
            "orderNumber": "", // Se llena al enviar
            "fecha": new Date().toLocaleDateString('pt-BR'),
            "Hora": new Date().toLocaleTimeString('en-US', { hour12: false }),
            "Solicitante": document.getElementById('solicitante').value.trim(),
            "Beneficiario": document.getElementById('beneficiario').value.trim(),
            "Tipo de ID": document.getElementById('tipoID').value.trim(),
            "N√∫mero de ID": document.getElementById('numeroID').value.trim(),
            "Tipo de cuenta": document.getElementById('tipoCuenta').value.trim(),
            "N√∫mero de cuenta": document.getElementById('numeroCuenta').value.trim(),
            "cantidad": formatearMontoFiat(
                currentMode === 'receive'
                    ? limpiarNumeroBR(extraerValor(resultadoTexto, "Cantidad necesaria a enviar"))
                    : limpiarNumeroBR(document.getElementById('cantidadEnviar').value)
            ),
            "monedaOrigen": document.getElementById('monedaOrigen').value,
            "monedaDestino": document.getElementById('monedaDestino').value,
            "Valor cotizado": formatearMontoFiat(
                currentMode === 'receive'
                    ? limpiarNumeroBR(document.getElementById('cantidadRecibir').value)
                    : limpiarNumeroBR(extraerValor(resultadoTexto, "Monto Final a Recibir"))
            ),
            "Comision": parseFloat(limpiarNumeroBR(document.getElementById('comision').value)),
            "Modo": currentMode === 'send' ? "Enviar" : "Recibir",
            "Verificacion": ""
        };
    }

    // FUNCIONES DE APOYO (C√ÅLCULOS)
    async function obtenerTasaCambio(origen, destino) {
        const apiID = "colocagroupsas266471220";
        const apiKey = "p860ankk1m5q0e3q4l929blrr1";
        const url = `https://xecdapi.xe.com/v1/convert_from.json/?from=${origen}&to=${destino}&amount=1`;

        console.log("Obteniendo tasa de cambio de:", url);
        
        const response = await fetch(url, {
            method: 'GET',
            headers: { 'Authorization': 'Basic ' + btoa(`${apiID}:${apiKey}`) }
        });

        if (!response.ok) {
            throw new Error(`Error del servidor: ${response.statusText}`);
        }

        const data = await response.json();
        
        if (data?.to?.[0]?.mid) {
            return parseFloat(data.to[0].mid);
        }
        
        throw new Error("Formato de respuesta inesperado");
    }

    function calcularMontos(cantidad, comision, tasa, esModoRecibir) {
        let montoConvertido, montoComision, montoFinal, cantidadNecesaria;
        
        if (esModoRecibir) {
            montoFinal = cantidad;
            montoConvertido = montoFinal / (1 - (comision / 100));
            cantidadNecesaria = montoConvertido / tasa;
            montoComision = montoConvertido - montoFinal;
        } else {
            cantidadNecesaria = cantidad;
            montoConvertido = cantidad * tasa;
            montoComision = montoConvertido * (comision / 100);
            montoFinal = montoConvertido - montoComision;
        }
        
        return { montoConvertido, montoComision, montoFinal, cantidadNecesaria };
    }

    function formatearMontoFiat(numero) {
        if (isNaN(numero)) return "0,00";
        return numero.toLocaleString('pt-BR', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        });
    }

    function formatearTasaCambio(tasa) {
        if (isNaN(tasa)) return "1,000000";
        
        const str = tasa.toFixed(6);
        let [entera, decimal] = str.split('.');
        decimal = decimal.replace(/0+$/, '');
        if (decimal === '') decimal = '0';
        
        const decimalCount = Math.max(2, decimal.length);
        return tasa.toLocaleString('pt-BR', {
            minimumFractionDigits: decimalCount,
            maximumFractionDigits: 6
        });
    }

    function mostrarTasaCompleta(tasa) {
        if (isNaN(tasa)) return "1,000000";
        return tasa.toFixed(6).replace('.', ',');
    }

    function limpiarNumeroBR(valor) {
        if (!valor) return NaN;
        return parseFloat(valor.replace(/\./g, '').replace(',', '.'));
    }

    function extraerValor(texto, clave) {
        const regex = new RegExp(`${clave}:\\s*([\\d.,]+)`);
        const match = texto.match(regex);
        return match ? match[1] : null;
    }

    function configurarAutoFormato() {
        const campos = ['cantidadEnviar', 'cantidadRecibir', 'comision'];
        
        campos.forEach(id => {
            const input = document.getElementById(id);
            
            input.addEventListener('input', function(e) {
                const cursorPos = this.selectionStart;
                const originalLength = this.value.length;
                
                if (id === 'comision') {
                    let valor = this.value.replace(/[^\d,.]/g, '');
                    this.dataset.rawValue = valor.replace(/,/g, '.');
                    
                    if (e.inputType !== 'deleteContentBackward') {
                        valor = valor.replace('.', ',');
                    }
                    
                    const partes = valor.split(/[,.]/);
                    if (partes.length > 2) {
                        valor = partes[0] + ',' + partes.slice(1).join('');
                    }
                    
                    this.value = valor;
                } else {
                    let valor = this.value.replace(/[^\d]/g, '');
                    if (valor.length > 0) {
                        valor = parseInt(valor).toLocaleString('pt-BR');
                    }
                    this.value = valor;
                }
                
                const newLength = this.value.length;
                const lengthDiff = newLength - originalLength;
                this.setSelectionRange(cursorPos + lengthDiff, cursorPos + lengthDiff);
                
                validarCampo(this);
            });
            
            input.addEventListener('blur', function() {
                if (this.value === '') return;
                
                if (id === 'comision') {
                    let valor = parseFloat(this.dataset.rawValue || this.value.replace(',', '.'));
                    if (isNaN(valor)) {
                        this.value = '';
                        return;
                    }
                    
                    this.value = valor.toLocaleString('pt-BR', {
                        minimumFractionDigits: 2,
                        maximumFractionDigits: 2
                    });
                    this.dataset.rawValue = valor;
                }
            });
        });
    }

    function cargarTemaGuardado() {
        const savedTheme = localStorage.getItem('theme') || 'light';
        document.body.setAttribute('data-theme', savedTheme);
        document.getElementById('themeToggle').checked = savedTheme === 'dark';
        document.getElementById('themeLabel').textContent = savedTheme === 'dark' ? 'Modo Claro' : 'Modo Oscuro';
    }

    function resetForm() {
        document.getElementById('monedaOrigen').value = "COP";
        document.getElementById('monedaDestino').value = "COP";
        document.getElementById('cantidadEnviar').value = "";
        document.getElementById('cantidadRecibir').value = "";
        document.getElementById('comision').value = "5,00";
        document.getElementById('resultado').innerHTML = "";
        document.getElementById('datosEnvio').classList.add('hidden');
        document.querySelectorAll('#datosEnvio input').forEach(input => input.value = "");
        setMode('send');
        
        document.querySelectorAll('.error-message').forEach(el => {
            el.style.display = 'none';
        });
        
        // Scroll al inicio
        setTimeout(() => {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }, 100);
    }

    // EVENT LISTENERS
    document.getElementById('themeToggle').addEventListener('change', function() {
        const theme = this.checked ? 'dark' : 'light';
        document.body.setAttribute('data-theme', theme);
        localStorage.setItem('theme', theme);
        document.getElementById('themeLabel').textContent = theme === 'dark' ? 'Modo Claro' : 'Modo Oscuro';
    });
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cotizador de env√≠os</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&display=swap');
        :root {
            --bg-color: #f4f4f4;
            --text-color: #13252B;
            --container-bg: #fff;
            --input-bg: #f9f9f9;
            --border-color: #ddd;
            --primary-color: #00B022;
            --primary-hover: #038919;
            --shadow: 0 0 15px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
            --border-radius: 10px;
        }
        
        [data-theme="dark"] {
            --bg-color: #121212;
            --text-color: #f0f0f0;
            --container-bg: #1e1e1e;
            --input-bg: #2d2d2d;
            --border-color: #444;
            --primary-color: #00a020;
            --primary-hover: #007a18;
            --shadow: 0 0 15px rgba(0, 0, 0, 0.3);
        }
        
        * {
            box-sizing: border-box;
            transition: background-color 0.3s, color 0.3s;
        }
        
        body {
            font-family: 'Montserrat', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            line-height: 1.6;
        }
        
        .container {
            background-color: var(--container-bg);
            padding: 30px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            width: 100%;
            max-width: 800px;
            text-align: center;
            position: relative;
            animation: fadeIn 0.5s ease-out;
            overflow: hidden;
            display: none;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        h1 {
            color: var(--text-color);
            margin-bottom: 20px;
            font-size: clamp(1.5rem, 2.5vw, 2rem);
            animation: slideDown 0.5s ease-out;
        }
        
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        label {
            display: block;
            margin-top: 15px;
            color: var(--text-color);
            font-weight: 600;
            text-align: left;
            font-size: 0.9rem;
        }
        
        input, select, button {
            width: 100%;
            padding: 12px 15px;
            margin-top: 8px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            font-family: 'Montserrat', sans-serif;
            font-size: 0.95rem;
            transition: var(--transition);
        }
        
        input, select {
            background-color: var(--input-bg);
            color: var(--text-color);
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(0, 176, 34, 0.2);
        }
        
        button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            cursor: pointer;
            margin-top: 20px;
            font-weight: 600;
            letter-spacing: 0.5px;
            transition: var(--transition);
        }
        
        button:hover {
            background-color: var(--primary-hover);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        #resultado {
            margin-top: 25px;
            font-size: 1rem;
            color: var(--text-color);
            text-align: left;
            background: rgba(0, 176, 34, 0.05);
            padding: 15px;
            border-radius: var(--border-radius);
            border-left: 4px solid var(--primary-color);
            animation: fadeIn 0.5s ease-out;
            display: none;
            opacity: 0;
        }
        
        #resultado.visible {
            display: block;
            opacity: 1;
        }
        
        #resultado h3 {
            color: var(--primary-color);
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 1.2rem;
        }
        
        #resultado p {
            margin: 10px 0;
            padding: 5px 0;
            border-bottom: 1px dashed var(--border-color);
        }
        
        #resultado p:last-child {
            border-bottom: none;
            font-weight: 600;
        }
        
        #resultado .monto-final {
            color: var(--primary-color);
            font-weight: 800;
            font-size: 1.1rem;
        }
        
        .spinner {
            display: none;
            margin: 20px auto;
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .hidden {
            display: none !important;
        }
        
        img {
            width: 200px;
            max-width: 80%;
            margin-bottom: 20px;
            animation: fadeIn 0.8s ease-out;
        }
        
        .form-section {
            margin-bottom: 30px;
            animation: fadeIn 0.6s ease-out;
        }
        
        .mode-selector {
            display: flex;
            justify-content: center;
            margin-bottom: 25px;
            gap: 10px;
        }
        
        .mode-btn {
            padding: 12px 25px;
            background-color: var(--input-bg);
            color: var(--text-color);
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: var(--transition);
            font-weight: 600;
            font-size: 0.9rem;
            flex: 1;
            max-width: 200px;
            text-align: center;
            border: 1px solid var(--border-color);
        }
        
        .mode-btn.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        
        .mode-btn:not(.active):hover {
            background-color: var(--bg-color);
        }
        
        .error-message {
            color: #ff4444;
            font-size: 0.8rem;
            margin-top: 5px;
            display: none;
            text-align: left;
            animation: shake 0.3s ease;
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            20%, 60% { transform: translateX(-5px); }
            40%, 80% { transform: translateX(5px); }
        }
        
        .important-field {
            font-weight: 800;
            color: var(--primary-color);
            margin-top: 20px;
            font-size: 1rem;
            display: flex;
            align-items: center;
        }
        
        .important-input {
            border: 2px solid var(--primary-color);
            background-color: rgba(0, 176, 34, 0.05);
            font-weight: 600;
            transition: var(--transition);
        }
        
        .field-icon {
            margin-right: 8px;
            font-size: 1.1em;
        }
        
        @keyframes pulseGlow {
            0% { box-shadow: 0 0 0 rgba(0, 176, 34, 0); }
            50% { box-shadow: 0 0 10px rgba(0, 176, 34, 0.3); }
            100% { box-shadow: 0 0 0 rgba(0, 176, 34, 0); }
        }
        
        .important-input:focus {
            animation: pulseGlow 2s infinite;
            outline: none;
            background-color: var(--input-bg);
        }
        
        .theme-switch {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }
        
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .slider {
            background-color: var(--primary-color);
        }
        
        input:checked + .slider:before {
            transform: translateX(26px);
        }
        
        #themeLabel {
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        /* Modal de Login */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .modal-content {
            background-color: var(--container-bg);
            padding: 40px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            width: 100%;
            max-width: 400px;
            text-align: center;
            animation: fadeIn 0.3s ease-out;
        }
        
        [data-theme="dark"] .modal-content {
            background-color: var(--container-bg);
            color: var(--text-color);
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }
            
            .mode-selector {
                flex-direction: column;
                align-items: center;
            }
            
            .mode-btn {
                max-width: 100%;
                width: 100%;
            }
            
            .theme-switch {
                position: static;
                justify-content: flex-end;
                margin-bottom: 15px;
            }
            
            input, select, button {
                padding: 10px 12px;
            }
            
            #resultado {
                font-size: 0.9rem;
            }
        }
        
        @media (max-width: 480px) {
            body {
                padding: 10px;
            }
            
            .container {
                padding: 15px;
            }
            
            h1 {
                font-size: 1.3rem;
                margin-bottom: 15px;
            }
            
            label {
                font-size: 0.85rem;
            }
            
            .modal-content {
                padding: 25px;
            }
        }
        
        /* Animaci√≥n para los campos del formulario */
        .form-section > * {
            animation: fadeInUp 0.5s ease-out forwards;
            opacity: 0;
            transform: translateY(10px);
        }
        
        @keyframes fadeInUp {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>
<body data-theme="light">
    <!-- Modal de Login -->
    <div id="loginModal" class="modal" style="display: flex;">
        <div class="modal-content">
            <img src="Logo color horizontal.png" alt="Logo" class="logo" style="margin-bottom: 30px;">
            <h2>Acceso Operadores</h2>
            <p>Ingrese su c√≥digo de 4 d√≠gitos</p>
            
            <div style="position: relative;">
                <input type="password" id="operadorPassword" maxlength="4" 
                       style="text-align: center; letter-spacing: 10px; font-size: 24px;"
                       oninput="this.value = this.value.replace(/[^0-9]/g, '')">
                <div class="error-message" id="loginError" style="text-align: center; margin-top: 10px;"></div>
            </div>
            
            <button onclick="verificarOperador()" style="margin-top: 25px;">Ingresar</button>
            
            <div id="operadorInfo" style="margin-top: 20px; display: none;">
                <p>Bienvenido, <span id="nombreOperador"></span></p>
            </div>
        </div>
    </div>

    <!-- Aplicaci√≥n principal -->
    <div class="container">
        <div class="theme-switch">
            <label class="switch">
                <input type="checkbox" id="themeToggle">
                <span class="slider round"></span>
            </label>
            <span id="themeLabel">Modo Oscuro</span>
        </div>
        
        <img src="Logo color horizontal.png" alt="Logo" class="logo">
        <h1>Cotizador de env√≠os</h1>
        
        <div class="mode-selector">
            <div class="mode-btn active" id="modeSend" onclick="setMode('send')">Quiero enviar</div>
            <div class="mode-btn" id="modeReceive" onclick="setMode('receive')">Quiero recibir</div>
        </div>

        <div class="form-section">
            <label for="monedaOrigen">Moneda de Origen:</label>
            <select id="monedaOrigen">
                <option value="COP">Peso Colombiano (COP)</option>
                <option value="BRL">Real Brasile√±o (BRL)</option>
                <option value="MXN">Peso Mexicano (MXN)</option>
                <option value="CLP">Peso Chileno (CLP)</option>
                <option value="PEN">Sol Peruano (PEN)</option>
                <option value="PYG">Guaran√≠ Paraguayo (PYG)</option>
                <option value="UYU">Peso Uruguayo (UYU)</option>
                <option value="USD">D√≥lar Estadounidense (USD)</option>
                <option value="EUR">Euro (EUR)</option>
                <option value="HKD">D√≥lar de Hong Kong (HKD)</option>
                <option value="CNY">Yuan Chino (CNY)</option>
            </select>
            <label for="monedaDestino">Moneda de Destino:</label>
            <select id="monedaDestino">
                <option value="COP">Peso Colombiano (COP)</option>
                <option value="BRL">Real Brasile√±o (BRL)</option>
                <option value="MXN">Peso Mexicano (MXN)</option>
                <option value="CLP">Peso Chileno (CLP)</option>
                <option value="PEN">Sol Peruano (PEN)</option>
                <option value="PYG">Guaran√≠ Paraguayo (PYG)</option>
                <option value="UYU">Peso Uruguayo (UYU)</option>
                <option value="USD">D√≥lar Estadounidense (USD)</option>
                <option value="EUR">Euro (EUR)</option>
                <option value="HKD">D√≥lar de Hong Kong (HKD)</option>
                <option value="CNY">Yuan Chino (CNY)</option>
            </select>
            
            <div id="sendSection">
                <label for="cantidadEnviar" class="important-field">
                    <span class="field-icon">üí∞</span>
                    Cantidad a enviar:
                </label>
                <input type="text" id="cantidadEnviar" placeholder="Ej: 1.000.000" class="important-input">
                <div class="error-message" id="errorCantidadEnviar">Ingrese un valor num√©rico v√°lido</div>
            </div>
            
            <div id="receiveSection" class="hidden">
                <label for="cantidadRecibir" class="important-field">
                    <span class="field-icon">üí∞</span>
                    Cantidad a recibir:
                </label>
                <input type="text" id="cantidadRecibir" placeholder="Ej: 500.000" class="important-input">
                <div class="error-message" id="errorCantidadRecibir">Ingrese un valor num√©rico v√°lido</div>
            </div>
            
            <label for="comision">Comisi√≥n (%):</label>
            <input type="text" id="comision" placeholder="Ej: 5,00" value="5,00">
            <div class="error-message" id="errorComision">Ingrese un porcentaje v√°lido (0-100)</div>
            
            <button onclick="calcularEnvio()">Cotizar</button>
            <div class="spinner" id="spinner"></div>
            <div id="resultado"></div>
        </div>
    </div>

<script>
    // CONSTANTES Y VARIABLES GLOBALES
    const SHEETDB_URL = 'https://sheetdb.io/api/v1/737yngerfyuzt'; // Tu URL de SheetDB
    const SHEET_NAME = 'HistorialCotizaciones';
    const OPERADORES = {
        "9345": "Mauricio",
        "0307": "Stephany",
        "8575": "Salom√≥n Saldarriaga",
        "5658": "Carlos",
        "4234": "Juan Marquez",
        "1678": "Juan Jose",
        "5234": "Pedro",
        "5178": "Carlo2s",
        "6234": "An2a",
        "7000": "Modo Prueba" // Contrase√±a de prueba
    };
    
    let currentMode = 'send';
    let tasaCambioActual = 0;
    let operadorActual = null;
    let ipCliente = null;
    
    // INICIALIZACI√ìN
    document.addEventListener('DOMContentLoaded', async function() {
        // Obtener IP del cliente
        ipCliente = await obtenerIP();
        
        // Configurar el resto
        configurarAutoFormato();
        setMode('send');
        cargarTemaGuardado();
        
        // Mostrar modal de login (el container principal queda oculto)
        document.getElementById('loginModal').style.display = 'flex';
        document.getElementById('operadorPassword').focus();
        
        // Agregar animaci√≥n de carga inicial
        document.querySelectorAll('.form-section > *').forEach((el, index) => {
            el.style.animationDelay = `${index * 0.1}s`;
        });
    });

    // FUNCIONES PRINCIPALES
    function setMode(mode) {
        currentMode = mode;
        document.getElementById('modeSend').classList.toggle('active', mode === 'send');
        document.getElementById('modeReceive').classList.toggle('active', mode === 'receive');
        document.getElementById('sendSection').classList.toggle('hidden', mode !== 'send');
        document.getElementById('receiveSection').classList.toggle('hidden', mode !== 'receive');
        
        // Enfocar autom√°ticamente el campo correspondiente
        setTimeout(() => {
            const fieldToFocus = mode === 'send' ? 'cantidadEnviar' : 'cantidadRecibir';
            document.getElementById(fieldToFocus)?.focus();
        }, 100);
    }

    // Funci√≥n para verificar operador
    function verificarOperador() {
        const password = document.getElementById('operadorPassword').value;
        const errorElement = document.getElementById('loginError');
        
        if (password.length !== 4) {
            errorElement.textContent = "El c√≥digo debe tener 4 d√≠gitos";
            errorElement.style.display = 'block';
            return;
        }
        
        if (!OPERADORES[password]) {
            errorElement.textContent = "C√≥digo incorrecto";
            errorElement.style.display = 'block';
            return;
        }
        
        // Login exitoso
        operadorActual = {
            codigo: password,
            nombre: OPERADORES[password]
        };
        
        document.getElementById('nombreOperador').textContent = operadorActual.nombre;
        document.getElementById('operadorInfo').style.display = 'block';
        errorElement.style.display = 'none';
        
        // Ocultar modal y mostrar aplicaci√≥n despu√©s de 1 segundo
        setTimeout(() => {
            document.getElementById('loginModal').style.display = 'none';
            document.querySelector('.container').style.display = 'block';
        }, 1000);
    }

    async function calcularEnvio() {
        try {
            // Validar campos b√°sicos
            if (!validarCamposCotizacion()) {
                console.warn("Validaci√≥n fallida en campos de cotizaci√≥n");
                return;
            }

            // Obtener datos del formulario
            const { monedaOrigen, monedaDestino, comision, cantidad } = obtenerDatosCotizacion();
            const esModoRecibir = currentMode === 'receive';
            
            console.log("Datos obtenidos:", { 
                monedaOrigen, 
                monedaDestino, 
                comision, 
                cantidad, 
                modo: currentMode 
            });

            // Validar que el operador est√© autenticado
            if (!operadorActual || !operadorActual.codigo) {
                throw new Error("Operador no autenticado");
            }

            // Mostrar spinner
            document.getElementById('spinner').style.display = 'block';
            document.querySelector('button').classList.add('loading');

            // Obtener tasa de cambio con validaci√≥n
            tasaCambioActual = await obtenerTasaCambio(monedaOrigen, monedaDestino);
            console.log("Tasa obtenida:", tasaCambioActual);
            
            // Calcular montos
            const { montoConvertido, montoComision, montoFinal, cantidadNecesaria } = calcularMontos(
                cantidad, 
                comision, 
                tasaCambioActual, 
                esModoRecibir
            );

            // Validar montos calculados
            if (!validarMontosCalculados({
                montoConvertido, 
                montoComision, 
                montoFinal, 
                cantidadNecesaria,
                monedaOrigen,
                monedaDestino
            })) {
                throw new Error("Los montos calculados no son v√°lidos");
            }

            // Mostrar resultados primero para mejor experiencia de usuario
            mostrarResultados(monedaOrigen, monedaDestino, cantidad, montoConvertido, montoComision, montoFinal, cantidadNecesaria, comision);

            // Guardar en historial (solo si todo es v√°lido)
            await guardarCotizacion({
                modo: currentMode,
                monedaOrigen,
                monedaDestino,
                montoOrigen: esModoRecibir ? cantidadNecesaria : cantidad,
                montoDestino: montoFinal,
                tasaCambio: tasaCambioActual,
                comision: parseFloat(comision),
                montoComision,
                montoFinal
            });

        } catch (error) {
            console.error('Error en calcularEnvio:', error);
            mostrarError('Error al procesar la cotizaci√≥n: ' + error.message);
        } finally {
            document.getElementById('spinner').style.display = 'none';
            document.querySelector('button').classList.remove('loading');
        }
    }

    function validarMontosCalculados(montos) {
        // Validar que ning√∫n monto sea NaN
        if (isNaN(montos.montoConvertido) || isNaN(montos.montoComision) || 
            isNaN(montos.montoFinal) || isNaN(montos.cantidadNecesaria)) {
            console.error("Montos calculados inv√°lidos (NaN)");
            return false;
        }

        // Validar que los montos sean positivos
        if (montos.montoConvertido <= 0 || montos.montoFinal <= 0 || montos.cantidadNecesaria <= 0) {
            console.error("Montos calculados deben ser positivos");
            return false;
        }

        // Validar que la comisi√≥n no sea mayor que el monto convertido
        if (montos.montoComision >= montos.montoConvertido) {
            console.error("La comisi√≥n no puede ser mayor que el monto convertido");
            return false;
        }

        // Validaci√≥n adicional para tasas extremas
        if (montos.monedaOrigen === montos.monedaDestino && tasaCambioActual !== 1) {
            console.error("Tasa de cambio inv√°lida para misma moneda");
            return false;
        }

        return true;
    }

    function mostrarResultados(monedaOrigen, monedaDestino, cantidad, montoConvertido, montoComision, montoFinal, cantidadNecesaria, comision) {
        const resultadoDiv = document.getElementById('resultado');
        
        // Limpiar y mostrar el div
        resultadoDiv.innerHTML = '';
        resultadoDiv.classList.add('visible');
        
        // Formatear el porcentaje de comisi√≥n (reemplazar punto por coma)
        const comisionFormateada = comision.toString().replace('.', ',');
        
        // Crear contenido HTML directamente
        resultadoDiv.innerHTML = `
            <h3 style="color: var(--primary-color); margin-top: 0; margin-bottom: 15px;">üìä Resultado de la Cotizaci√≥n</h3>
            <p><strong>Operador:</strong> ${operadorActual?.nombre || 'No identificado'}</p>
            <p><strong>üí± Tasa de Cambio:</strong> 1 ${monedaOrigen} = ${formatearTasaCambio(tasaCambioActual)} ${monedaDestino}</p>
            ${currentMode === 'receive' ? 
                `<p><strong>üì§ Cantidad necesaria a enviar:</strong> <span class="monto-final">${formatearMontoFiat(cantidadNecesaria)} ${monedaOrigen}</span></p>
                 <p><strong>üì• Monto que recibir√°:</strong> ${formatearMontoFiat(cantidad)} ${monedaDestino}</p>` : 
                `<p><strong>üì§ Monto que env√≠a:</strong> ${formatearMontoFiat(cantidad)} ${monedaOrigen}</p>
                 <p><strong>üì• Monto que recibir√°:</strong> ${formatearMontoFiat(montoFinal)} ${monedaDestino}</p>`}
            <p><strong>üîÑ Monto Convertido:</strong> ${formatearMontoFiat(montoConvertido)} ${monedaDestino}</p>
            <p><strong>üí∏ Comisi√≥n (${comisionFormateada}%):</strong> -${formatearMontoFiat(montoComision)} ${monedaDestino}</p>
            <p><strong>‚úÖ Monto Final:</strong> ${currentMode === 'receive' ? 
                `${formatearMontoFiat(montoFinal)} ${monedaDestino}` : 
                `<span class="monto-final">${formatearMontoFiat(montoFinal)} ${monedaDestino}</span>`}</p>
        `;
    }

    async function guardarCotizacion(datos) {
        try {
            // Validaci√≥n adicional antes de guardar
            if (!operadorActual) {
                throw new Error("Operador no identificado");
            }

            if (!datos.tasaCambio || isNaN(datos.tasaCambio) || datos.tasaCambio <= 0) {
                throw new Error(`Tasa de cambio inv√°lida: ${datos.tasaCambio}`);
            }

            // Asegurar que los montos son n√∫meros v√°lidos
            const montoOrigen = parseFloat(datos.montoOrigen);
            const montoDestino = parseFloat(datos.montoDestino);
            if (isNaN(montoOrigen)) throw new Error("Monto origen inv√°lido");
            if (isNaN(montoDestino)) throw new Error("Monto destino inv√°lido");

            // Formatear fecha y hora consistentemente
            const now = new Date();
            const fecha = now.toISOString().split('T')[0]; // Formato YYYY-MM-DD
            const hora = now.toTimeString().split(' ')[0]; // Formato HH:MM:SS

            const payload = {
                "Fecha": fecha,
                "Hora": hora,
                "Usuario": operadorActual.nombre,
                "CodigoOperador": operadorActual.codigo,
                "Modo": datos.modo === 'send' ? "Enviar" : "Recibir",
                "MonedaOrigen": datos.monedaOrigen,
                "MonedaDestino": datos.monedaDestino,
                "MontoOrigen": montoOrigen,
                "MontoDestino": montoDestino,
                "TasaCambio": parseFloat(datos.tasaCambio.toFixed(6)),
                "Comision": parseFloat(datos.comision.toFixed(2)),
                "MontoComision": parseFloat(datos.montoComision.toFixed(2)),
                "MontoFinal": parseFloat(datos.montoFinal.toFixed(2)),
                "IPCliente": ipCliente || 'Desconocida'
            };

            console.log("Enviando a SheetDB:", payload);
            
            const response = await fetch(`${SHEETDB_URL}?sheetName=${SHEET_NAME}`, {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer YOUR_API_KEY' // Si es necesario
                },
                body: JSON.stringify({ data: [payload] }) // Asegurar que es un array
            });
            
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(`Error al guardar: ${errorData.message || response.statusText}`);
            }
            
            return await response.json();
        } catch (error) {
            console.error("Error al guardar cotizaci√≥n:", error);
            // Mostrar error al usuario de forma no intrusiva
            mostrarError("Ocurri√≥ un error al guardar el historial. La cotizaci√≥n se calcul√≥ correctamente.");
        }
    }

    async function obtenerIP() {
        try {
            const response = await fetch('https://api.ipify.org?format=json');
            const data = await response.json();
            return data.ip || 'Desconocida';
        } catch {
            return 'Desconocida';
        }
    }

    async function obtenerTasaCambio(origen, destino) {
        try {
            // Si las monedas son iguales, retornar 1 directamente
            if (origen === destino) return 1;

            const apiID = "colocagroupsas266471220";
            const apiKey = "p860ankk1m5q0e3q4l929blrr1";
            const url = `https://xecdapi.xe.com/v1/convert_from.json/?from=${origen}&to=${destino}&amount=1`;

            console.log("Obteniendo tasa de cambio de:", url);
            
            const response = await fetch(url, {
                method: 'GET',
                headers: { 'Authorization': 'Basic ' + btoa(`${apiID}:${apiKey}`) }
            });

            if (!response.ok) {
                throw new Error(`Error del servidor: ${response.statusText}`);
            }

            const data = await response.json();
            
            if (!data?.to?.[0]?.mid) {
                throw new Error("Formato de respuesta inesperado");
            }

            const tasa = parseFloat(data.to[0].mid);
            
            // Validar que la tasa sea razonable
            if (tasa <= 0) {
                throw new Error(`Tasa de cambio inv√°lida: ${tasa}`);
            }
            
            return parseFloat(tasa.toFixed(6));
            
        } catch (error) {
            console.error("Error al obtener tasa:", error);
            throw new Error("No se pudo obtener la tasa de cambio. Intente nuevamente.");
        }
    }

    function mostrarError(mensaje) {
        const resultado = document.getElementById('resultado');
        resultado.classList.add('visible');
        resultado.innerHTML = `
            <p style="color: #ff4444; font-weight: 600; animation: shake 0.5s;">
                ‚úó ${mensaje}
            </p>
        `;
    }

    // FUNCIONES DE APOYO (VALIDACI√ìN)
    function validarCamposCotizacion() {
        const campos = currentMode === 'send' 
            ? ['cantidadEnviar', 'comision'] 
            : ['cantidadRecibir', 'comision'];
        
        let todosValidos = true;
        
        campos.forEach(id => {
            const input = document.getElementById(id);
            if (!validarCampo(input)) {
                todosValidos = false;
                // Scroll al campo con error
                setTimeout(() => {
                    input.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }, 100);
            }
        });
        
        if (!todosValidos) {
            return false;
        }
        
        return true;
    }

    function validarCampo(input) {
        const value = input.value;
        const errorId = `error${input.id.charAt(0).toUpperCase() + input.id.slice(1)}`;
        const errorElement = document.getElementById(errorId);
        
        if (!errorElement) return true;
        
        let isValid = true;
        
        if (input.id === 'comision') {
            const valorNumerico = parseFloat(input.dataset.rawValue || value.replace(',', '.'));
            isValid = !isNaN(valorNumerico) && valorNumerico >= 0 && valorNumerico <= 100;
        } else {
            const valorNumerico = parseInt(value.replace(/\./g, ''));
            isValid = !isNaN(valorNumerico) && valorNumerico > 0;
        }
        
        errorElement.style.display = isValid ? 'none' : 'block';
        return isValid;
    }

    // FUNCIONES DE APOYO (DATOS)
    function obtenerDatosCotizacion() {
        return {
            monedaOrigen: document.getElementById('monedaOrigen').value,
            monedaDestino: document.getElementById('monedaDestino').value,
            comision: limpiarNumeroBR(document.getElementById('comision').value),
            cantidad: limpiarNumeroBR(
                currentMode === 'receive' 
                    ? document.getElementById('cantidadRecibir').value 
                    : document.getElementById('cantidadEnviar').value
            )
        };
    }

    function calcularMontos(cantidad, comision, tasa, esModoRecibir) {
        let montoConvertido, montoComision, montoFinal, cantidadNecesaria;
        
        if (esModoRecibir) {
            // Modo "Quiero recibir": calcular cu√°nto necesito enviar para recibir X
            montoFinal = cantidad;
            montoConvertido = montoFinal / (1 - (comision / 100));
            cantidadNecesaria = montoConvertido / tasa;
            montoComision = montoConvertido - montoFinal;
        } else {
            // Modo "Quiero enviar": calcular cu√°nto recibir√© al enviar X
            cantidadNecesaria = cantidad;
            montoConvertido = cantidad * tasa;
            montoComision = montoConvertido * (comision / 100);
            montoFinal = montoConvertido - montoComision;
        }
        
        return { montoConvertido, montoComision, montoFinal, cantidadNecesaria };
    }

    function formatearMontoFiat(numero) {
        if (isNaN(numero)) return "0,00";
        return numero.toLocaleString('pt-BR', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        });
    }

    function formatearTasaCambio(tasa) {
        if (isNaN(tasa)) return "1,000000";
        
        const str = tasa.toFixed(6);
        let [entera, decimal] = str.split('.');
        decimal = decimal.replace(/0+$/, '');
        if (decimal === '') decimal = '0';
        
        const decimalCount = Math.max(2, decimal.length);
        return tasa.toLocaleString('pt-BR', {
            minimumFractionDigits: decimalCount,
            maximumFractionDigits: 6
        });
    }

    function limpiarNumeroBR(valor) {
        if (!valor) return NaN;
        return parseFloat(valor.replace(/\./g, '').replace(',', '.'));
    }

    function configurarAutoFormato() {
        const campos = ['cantidadEnviar', 'cantidadRecibir', 'comision'];
        
        campos.forEach(id => {
            const input = document.getElementById(id);
            
            // Guardar posici√≥n del cursor y valor original
            let lastValue = input.value;
            
            input.addEventListener('input', function(e) {
                // Permitir retroceso y borrado
                if (e.inputType === 'deleteContentBackward' || e.inputType === 'deleteContentForward') {
                    lastValue = input.value;
                    return;
                }
                
                // Solo para campos de cantidad (no comisi√≥n)
                if (id === 'cantidadEnviar' || id === 'cantidadRecibir') {
                    // Permitir n√∫meros, punto o coma
                    const newValue = input.value.replace(/[^\d,.]/g, '');
                    
                    // Reemplazar coma por punto internamente
                    const rawValue = newValue.replace(/,/g, '.');
                    
                    // Guardar el valor num√©rico real
                    input.dataset.rawValue = rawValue;
                    
                    // Mostrar el valor con la coma decimal
                    input.value = newValue.replace('.', ',');
                    
                    lastValue = input.value;
                    return;
                }
                
                // Comportamiento original para comisi√≥n
                if (id === 'comision') {
                    let valor = input.value.replace(/[^\d,.]/g, '');
                    input.dataset.rawValue = valor.replace(/,/g, '.');
                    
                    if (e.inputType !== 'deleteContentBackward') {
                        valor = valor.replace('.', ',');
                    }
                    
                    const partes = valor.split(/[,.]/);
                    if (partes.length > 2) {
                        valor = partes[0] + ',' + partes.slice(1).join('');
                    }
                    
                    input.value = valor;
                    lastValue = input.value;
                }
            });
            
            input.addEventListener('blur', function() {
                if (input.value === '') return;
                
                // Formatear al perder el foco
                if (id === 'cantidadEnviar' || id === 'cantidadRecibir') {
                    const rawValue = parseFloat(input.dataset.rawValue || input.value.replace(/\./g, '').replace(',', '.'));
                    
                    if (!isNaN(rawValue)) {
                        input.value = rawValue.toLocaleString('pt-BR', {
                            minimumFractionDigits: 2,
                            maximumFractionDigits: 2
                        });
                        input.dataset.rawValue = rawValue;
                    } else {
                        input.value = '';
                    }
                } else if (id === 'comision') {
                    let valor = parseFloat(input.dataset.rawValue || input.value.replace(',', '.'));
                    if (isNaN(valor)) {
                        input.value = '';
                        return;
                    }
                    
                    input.value = valor.toLocaleString('pt-BR', {
                        minimumFractionDigits: 2,
                        maximumFractionDigits: 2
                    });
                    input.dataset.rawValue = valor;
                }
            });
        });
    }

    function cargarTemaGuardado() {
        const savedTheme = localStorage.getItem('theme') || 'light';
        document.body.setAttribute('data-theme', savedTheme);
        document.getElementById('themeToggle').checked = savedTheme === 'dark';
        document.getElementById('themeLabel').textContent = savedTheme === 'dark' ? 'Modo Claro' : 'Modo Oscuro';
    }

    function resetForm() {
        document.getElementById('monedaOrigen').value = "COP";
        document.getElementById('monedaDestino').value = "COP";
        document.getElementById('cantidadEnviar').value = "";
        document.getElementById('cantidadRecibir').value = "";
        document.getElementById('comision').value = "5,00";
        document.getElementById('resultado').innerHTML = "";
        document.getElementById('resultado').classList.remove('visible');
        setMode('send');
        
        document.querySelectorAll('.error-message').forEach(el => {
            el.style.display = 'none';
        });
        
        // Scroll al inicio
        setTimeout(() => {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }, 100);
    }

    // EVENT LISTENERS
    document.getElementById('themeToggle').addEventListener('change', function() {
        const theme = this.checked ? 'dark' : 'light';
        document.body.setAttribute('data-theme', theme);
        localStorage.setItem('theme', theme);
        document.getElementById('themeLabel').textContent = theme === 'dark' ? 'Modo Claro' : 'Modo Oscuro';
    });

    // Permitir login con Enter
    document.getElementById('operadorPassword').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            verificarOperador();
        }
    });
</script>
</body>
</html>
